#!/bin/bash

VERSION=$ASDF_INSTALL_VERSION
BASE_URL="https://downloads.haskell.org/~ghc/${VERSION}/"

asd() {
  local download_dir="/home/sestrella/tmp"
  curl -o "$download_dir/ghc.tar.xz" $(download_url)
  ls $download_dir
}

download_url() {
  local assets=$(available_assets)
  local filename=$(filter_assets "$assets" 0 || filter_assets "$assets" 1)
  echo "${BASE_URL}${filename}"
}

filter_assets() {
  echo "$1" | compatible_assets "$2"
}

available_assets() {
  curl -s --compressed "$BASE_URL" | href | grep "^ghc-${VERSION}" | grep -v '\.sig$'
}

href() {
  grep -o 'href=".*"' | sed 's/href="//g' | sed 's/"//g'
}

compatible_assets() {
  local bar=$(distro $1)
  grep "$bar" | grep 'tar.xz$'
}

distro() {
  local release=$(lsb_release -rs)
  local index=$1
  case "$(lsb_release -is)" in
    Debian)
      echo "$(uname -m)-deb$((release - index))"
      ;;
    *)
      echo "unknown"
      ;;
  esac
}

asd
